<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">

    <title>WhatsApp Chat Log Viewer</title>

    <link rel="stylesheet" href="style.css">
    <script src="//twemoji.maxcdn.com/2/twemoji.min.js?2.1"></script>
</head>
<body>
	<div class="header"><a href="#">WhatsApp Chat Log Viewer</a>
        <div onclick="showMore()" class="expand"><img id="moreBtn1" src="btn1.png"><img id="moreBtn2" src="btn2.png"></div>
    </div>
	<div id="pov" class="navbar">Select Perspective</div>
	
    <div class="loader">
        <div class="sk-cube-grid">
            <div class="sk-cube sk-cube1"></div>
            <div class="sk-cube sk-cube2"></div>
            <div class="sk-cube sk-cube3"></div>
            <div class="sk-cube sk-cube4"></div>
            <div class="sk-cube sk-cube5"></div>
            <div class="sk-cube sk-cube6"></div>
            <div class="sk-cube sk-cube7"></div>
            <div class="sk-cube sk-cube8"></div>
            <div class="sk-cube sk-cube9"></div>
        </div>
        <p>Loading</p>
    </div>

    <div id="chat" class="chat_box_wrapper chat_box_small chat_box_active" >
        <div class="chat_box chat_box_colors_a"></div>
    </div>

<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
<script type="text/javascript">
function LoadFile() {
    var oFrame = document.getElementById("frmFile");
    var strRawContents = oFrame.contentWindow.document.body.childNodes[0].innerHTML;
    if (!strRawContents) {
        $('.sk-cube-grid').remove();
        $('.loader > p').text("Error loading file '" + $('#frmFile').attr('src') + "'");
    }
    var arrLines = strRawContents.split("\n");

	var names = [];

    var prevFrom;
    var prevTimestamp = "";
    for (var i = 0; i < arrLines.length; i++) {
        var curLine = arrLines[i];

        split = curLine.split(/( - )|(: )/, 7);
        if (split.length == 7) {
            var timestamp = split[0];
            var from = split[3];
            var message = split[6];
            var className = from.replace(/ /g,'');
            if(names.indexOf(className)== -1){
                names.push(className);
                var povDiv = document.getElementById("pov");
                povDiv.innerHTML += "<button class=\"myButton\" onclick='changeCss(\""+className+"\",this)'>"+from+"</button>";
            }

            if (timestamp.split(', ')[0] != prevTimestamp.split(', ')[0]) {
                addAdmin(timestamp.split(', ')[0]);
            }

            if (timestamp && from && message && message.indexOf(".jpg (file attached)") != -1) {
                addImage(timestamp, from, message.split(" (file attached)"));
            } else if (timestamp && from && message && message.indexOf(".mp4 (file attached)") != -1) {
                addVideo(timestamp, from, message.split(" (file attached)"));
            } else if (timestamp && from && message) {
                if (from == prevFrom && timestamp == prevTimestamp) {
                    addContinuedMsg(message);
                } else {
                    addMsg(timestamp, from, message);
                }
            }

            prevFrom = from;
            prevTimestamp = timestamp;
        } else if (split.length == 4 && split[1] == " - " && !split[2]) {
            // admin message
            addAdmin(split[3]);
        } else {
            // multi line
            var timestamp = $('#chat > div > div:last-child() > ul > li > p:last-child() > span').remove();
            $('#chat > div > div:last-child() > ul > li > p:last-child()').append("<br>" + curLine).append(timestamp);
        }
    }

    $('.loader').remove();
}

var isShowing = false;
function showMore(){
	if(isShowing){
        $('#moreBtn2').hide();
        $('#moreBtn1').show();
        $('#pov').hide();
	}
	else{
        $('#moreBtn1').hide();
		$('#moreBtn2').show();
        $('#pov').show();
	}
	isShowing = !isShowing;
}

function addImage(timestamp, from, filename) {
    $(".chat_box").append(`
        <div class="chat_message_wrapper ` + from.replace(/ /g, '') + `">
            <ul class="chat_message">
                <li>
                    <p style="color: #` + intToRGB(hashCode(from)) + `;">
                        <b>` + from + `</b>
                    </p>
                    <p>
                        <img src="log/` + filename[0] + `">
                        <span class="chat_message_time">` + timestamp + `</span>
                    </p>
                </li>
            </ul>
        </div>
        `);
}

function addVideo(timestamp, from, filename) {
    $(".chat_box").append(`
        <div class="chat_message_wrapper ` + from.replace(/ /g, '') + `">
            <ul class="chat_message">
                <li>
                    <p style="color: #` + intToRGB(hashCode(from)) + `;">
                        <b>` + from + `</b>
                    </p>
                    <p>
                        <video controls>
                            <source src="log/` + filename[0] + `" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        <span class="chat_message_time">` + timestamp + `</span>
                    </p>
                </li>
            </ul>
        </div>
        `);
}

function addAdmin(message){
    $(".chat_box").append(`
        <div class="admin_message_wrapper">
            ` + message + `
        </div>
        `);
}

function addMsg(timestamp, from, message) {
    message = twemoji.parse(message.linkify());
    $(".chat_box").append(`
        <div class="chat_message_wrapper ` + from.replace(/ /g, '') + `">
            <ul class="chat_message">
                <li>
                    <p style="color: #` + intToRGB(hashCode(from)) + `;">
                        <b>` + from + `</b>
                    </p>
                    <p>
                        ` + message + `
                        <span class="chat_message_time">` + timestamp + `</span>
                    </p>
                </li>
            </ul>
        </div>
        `);
}

function addContinuedMsg(message) {
    var timestamp = $('#chat > div > div:last-child() > ul > li > p:last-child() > span').remove();
    $("#chat > div > div:last-child() > ul").append(`
                <li>
                    <p>
                    </p>
                    <p>
                        ` + message + `
                    </p>
                </li>
        `);
    $('#chat > div > div:last-child() > ul > li:last-child() > p:last-child()').append(timestamp);
}

function hashCode(str) {
    var hash = 0;
    for (var i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    return hash;
} 

function intToRGB(i){
    var c = (i & 0x00FFFFFF)
    .toString(16)
    .toUpperCase();

    return "00000".substring(0, 6 - c.length) + c;
}

var prevClassName ="";
function changeCss(selClassName,btn){
	var allOld = document.getElementsByClassName("chat_message_wrapper");
	var buttons = document.getElementsByClassName("myButton");
	for(i=0;i<buttons.length; i++){
		buttons[i].classList.remove("active");
	}
	for(i=0; i<allOld.length; i++){
		allOld[i].classList.remove("chat_message_right");
	}
	if(selClassName ==prevClassName){
		prevClassName = "";
		btn.classList.remove("active");
	}
	else{
		var newPov = document.getElementsByClassName(selClassName);
		for(i=0; i<newPov.length; i++){
			newPov[i].className +="chat_message_wrapper "+selClassName+"  chat_message_right";
		}
		btn.classList.add("active");
		prevClassName=selClassName;
	}
}

if(!String.linkify) {
    String.prototype.linkify = function() {

        // http://, https://, ftp://
        var urlPattern = /\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim;

        // www. sans http:// or https://
        var pseudoUrlPattern = /(^|[^\/])(www\.[\S]+(\b|$))/gim;

        // Email addresses
        var emailAddressPattern = /[\w.]+@[a-zA-Z_-]+?(?:\.[a-zA-Z]{2,6})+/gim;

        return this
            .replace(urlPattern, '<a href="$&">$&</a>')
            .replace(pseudoUrlPattern, '$1<a href="http://$2">$2</a>')
            .replace(emailAddressPattern, '<a href="mailto:$&">$&</a>');
    };
}
</script>

<iframe src="log/chatlog.txt" id="frmFile" onload="LoadFile();" style="display: none;"></iframe>

</body>
</html>
